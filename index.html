<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AdansiMart | Verified Marketplace</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AdansiMart">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png">
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkFkYW5zaU1hcnQiLAogICJzaG9ydF9uYW1lIjogIkFkYW5zaU1hcnQiLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMDBmZjg4IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMzA4MS8zMDgxODQwLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #ffffff; color: #111; font-family: 'Inter', sans-serif; scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        .hero-gradient { background: linear-gradient(180deg, #f0fff4 0%, #ffffff 100%); }
        .card { background: white; border-radius: 20px; border: 1px solid #e5e7eb; transition: 0.3s; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .btn-black { background: #000; color: #fff; font-weight: 700; }
        .btn-green { background: #00ff88; color: #000; font-weight: 800; }
        .input-field { width: 100%; padding: 14px; margin-bottom: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 16px; }
        .hidden { display: none; }
        .badge-pending { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <section id="hero" class="hero-gradient pt-24 pb-16 px-6 text-center">
        <div class="max-w-3xl mx-auto">
            <h1 onclick="adminTrigger()" class="text-6xl md:text-8xl font-black tracking-tighter mb-4 cursor-pointer select-none">
                ADANSIMART<span class="text-green-500">.</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-500 mb-10 font-medium">Safe Marketplace. Every seller is manually verified by Admin.</p>
            <div id="heroActions" class="flex flex-wrap justify-center gap-4">
                <button id="heroRegBtn" onclick="openModal('sellerModal')" class="btn-black px-10 py-5 rounded-full text-lg shadow-2xl">REGISTER BUSINESS</button>
                <a href="#market-start" class="px-10 py-5 rounded-full text-lg font-bold border-2 border-black">VIEW MARKET</a>
            </div>
            <div id="pendingNotice" class="hidden mt-6 bg-yellow-50 text-yellow-700 p-5 rounded-3xl border border-yellow-100 max-w-sm mx-auto text-sm font-bold">
                ⚠️ Your shop is pending admin approval.
            </div>
        </div>
    </section>

    <header class="sticky top-0 bg-white/90 backdrop-blur-xl border-b border-gray-100 p-4 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h2 class="font-black text-2xl tracking-tighter">AM<span class="text-green-500">.</span></h2>
            <div class="flex items-center gap-4">
                <div id="portalTabs" class="hidden flex gap-4 mr-2 border-r pr-4 border-gray-200 text-xs font-black uppercase">
                    <button onclick="switchView('all')" id="tabAll" class="text-green-600">Market</button>
                    <button onclick="switchView('mine')" id="tabMine" class="text-gray-400">My Store</button>
                </div>
                <button onclick="checkSellerStatus()" class="btn-green px-5 py-2 rounded-full text-xs uppercase tracking-widest">Post Item</button>
            </div>
        </div>
    </header>

    <div id="market-start" class="p-6 max-w-7xl mx-auto min-h-screen">
        <div class="flex justify-between items-center mb-10">
            <h3 id="viewTitle" class="text-3xl font-black italic">Verified Listings</h3>
            <button id="privateSettingsBtn" onclick="openModal('settingsModal')" class="hidden bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold border border-gray-200">⚙️ SHOP SETTINGS</button>
        </div>
        <main id="app-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></main>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/40 backdrop-blur-xl hidden flex flex-col items-center justify-center p-6 z-50">
        <div class="bg-white p-8 w-full max-w-md rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-1">Shop Settings</h2>
            <textarea id="setBio" class="input-field h-20 resize-none" placeholder="Business Bio"></textarea>
            <input type="text" id="setPhone" class="input-field" placeholder="WhatsApp (233...)">
            <button id="setBtn" onclick="updateGlobalProfile()" class="btn-black w-full py-4 rounded-2xl mb-3">SYNC PROFILE</button>
            <button onclick="logoutSeller()" class="w-full py-2 text-red-500 font-bold text-xs uppercase">Logout</button>
            <button onclick="closeModal('settingsModal')" class="w-full mt-4 text-gray-400 text-xs text-center">Close</button>
        </div>
    </div>

    <div id="sellerModal" class="fixed inset-0 bg-black/40 backdrop-blur-xl hidden flex flex-col items-center justify-center p-6 z-50">
        <div class="bg-white p-8 w-full max-w-md rounded-3xl shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-3xl font-black mb-2 italic">Join AdansiMart</h2>
            <input type="text" id="regShopName" placeholder="Business Name" class="input-field">
            <textarea id="regBio" placeholder="Short Shop Bio..." class="input-field h-20 resize-none"></textarea>
            <input type="text" id="regUsername" placeholder="Username (no spaces)" class="input-field">
            <label class="text-[10px] font-bold text-gray-400 uppercase">Ghana Card ID (GHA-XXXXXXXXX-X)</label>
            <input type="text" id="regGhanaCardNum" value="GHA-" class="input-field font-mono" maxlength="15">
            <input type="text" id="regPhone" placeholder="WhatsApp (233...)" class="input-field">
            <div class="grid grid-cols-2 gap-4 mb-6 text-[10px] font-bold text-gray-400">
                <div>LOGO <input type="file" id="regProfilePic" class="mt-1 block w-full"></div>
                <div>ID PHOTO <input type="file" id="regCardPhoto" class="mt-1 block w-full"></div>
            </div>
            <button id="regSubmitBtn" onclick="saveSellerProfile()" class="btn-black w-full py-4 rounded-2xl text-lg">Submit for Approval</button>
            <button onclick="closeModal('sellerModal')" class="w-full mt-4 text-gray-400 text-sm text-center">Cancel</button>
        </div>
    </div>

    <div id="postModal" class="fixed inset-0 bg-black/40 backdrop-blur-xl hidden flex flex-col items-center justify-center p-6 z-50">
        <div class="bg-white p-8 w-full max-w-md rounded-3xl shadow-2xl">
            <h2 id="postModalTitle" class="text-2xl font-bold mb-6">List Item</h2>
            <input type="file" id="fileInput" class="mb-4 block w-full text-xs">
            <input type="text" id="title" placeholder="Item Name" class="input-field">
            <textarea id="description" placeholder="Details..." class="input-field h-24 resize-none"></textarea>
            <input type="number" id="price" placeholder="Price (₵)" class="input-field">
            <button id="uploadBtn" onclick="handlePost()" class="btn-green w-full py-4 rounded-2xl shadow-lg">POST NOW</button>
            <button onclick="closeModal('postModal')" class="w-full mt-4 text-gray-400 text-xs text-center">Cancel</button>
        </div>
    </div>

    <div id="adminModal" class="fixed inset-0 bg-white hidden flex-col p-8 z-[60] overflow-y-auto">
        <div class="max-w-4xl mx-auto w-full flex justify-between mb-10 border-b pb-6">
            <h2 class="text-3xl font-black italic">ADMIN CONTROL</h2>
            <button onclick="closeModal('adminModal')" class="bg-black text-white px-6 py-2 rounded-full">EXIT</button>
        </div>
        <div id="admin-seller-list" class="space-y-4"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4895RrHcz4dikOD7EXP4rxjXM4zT6DYM",
            authDomain: "adansimart-web.firebaseapp.com",
            projectId: "adansimart-web",
            storageBucket: "adansimart-web.firebasestorage.app",
            messagingSenderId: "319539198262",
            appId: "1:319539198262:web:c600365a5eab9945ea9b97"
        };
        const CLOUD_NAME = "dpua9ympq";
        const UPLOAD_PRESET = "adansimart";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentView = 'all';
        let allSellers = {}; 

        window.adminTrigger = () => {
            const secret = prompt("Enter Master Key:");
            if (secret === "Adansi2026") { loadAdminData(); openModal('adminModal'); }
        };

        window.approveSeller = async (docId) => {
            if(confirm("Verify this shop?")) {
                await updateDoc(doc(db, "verified_sellers", docId), { verified: true });
                loadAdminData();
            }
        };

        window.openModal = (id) => {
            if(id === 'settingsModal') {
                const s = JSON.parse(localStorage.getItem('adansiSeller'));
                document.getElementById('setBio').value = s.bio || "";
                document.getElementById('setPhone').value = s.phone;
            }
            document.getElementById(id).style.display = 'flex';
        };
        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; }
        window.logoutSeller = () => { localStorage.removeItem('adansiSeller'); location.reload(); };

        window.switchView = (view) => {
            currentView = view;
            document.getElementById('tabAll').className = view === 'all' ? 'text-green-600' : 'text-gray-400';
            document.getElementById('tabMine').className = view === 'mine' ? 'text-green-600' : 'text-gray-400';
            document.getElementById('privateSettingsBtn').classList.toggle('hidden', view !== 'mine');
            renderFeed();
        }

        document.getElementById('regGhanaCardNum').addEventListener('input', function() {
            if (!this.value.startsWith('GHA-')) this.value = 'GHA-';
            this.value = this.value.toUpperCase();
        });

        onSnapshot(collection(db, "verified_sellers"), (snaps) => {
            snaps.forEach(d => {
                const data = d.data();
                allSellers[data.user] = { ...data, docId: d.id };
                const local = JSON.parse(localStorage.getItem('adansiSeller'));
                if(local && local.user === data.user) {
                    localStorage.setItem('adansiSeller', JSON.stringify({ ...data, docId: d.id }));
                    if(!data.verified) document.getElementById('pendingNotice').classList.remove('hidden');
                }
            });
            renderFeed();
        });

        window.saveSellerProfile = async function() {
            const btn = document.getElementById('regSubmitBtn');
            const cardNum = document.getElementById('regGhanaCardNum').value;
            const cardPattern = /^GHA-\d{9}-\d{1}$/;
            if (!cardPattern.test(cardNum)) return alert("ID format: GHA-123456789-0");

            try {
                btn.innerText = "Processing..."; btn.disabled = true;
                const upload = async (file) => {
                    const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
                    return (await res.json()).secure_url;
                };
                const profilePic = await upload(document.getElementById('regProfilePic').files[0]);
                const cardPhoto = await upload(document.getElementById('regCardPhoto').files[0]);
                
                const data = { 
                    name: document.getElementById('regShopName').value, bio: document.getElementById('regBio').value, 
                    user: document.getElementById('regUsername').value, phone: document.getElementById('regPhone').value, 
                    cardNum, profilePic, cardPhoto, verified: false 
                };
                const docRef = await addDoc(collection(db, "verified_sellers"), { ...data, createdAt: serverTimestamp() });
                localStorage.setItem('adansiSeller', JSON.stringify({ ...data, docId: docRef.id }));
                location.reload();
            } catch (e) { alert("Error."); btn.disabled = false; }
        }

        window.checkSellerStatus = () => {
            const s = JSON.parse(localStorage.getItem('adansiSeller'));
            if(!s) return openModal('sellerModal');
            if(!s.verified) return alert("Pending Admin Approval.");
            openModal('postModal');
        };

        window.handlePost = async function() {
            const btn = document.getElementById('uploadBtn');
            const s = JSON.parse(localStorage.getItem('adansiSeller'));
            try {
                btn.innerText = "Uploading..."; btn.disabled = true;
                const fd = new FormData(); fd.append('file', document.getElementById('fileInput').files[0]); fd.append('upload_preset', UPLOAD_PRESET);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
                const img = (await res.json()).secure_url;
                await addDoc(collection(db, "listings"), {
                    title: document.getElementById('title').value, description: document.getElementById('description').value, 
                    price: document.getElementById('price').value, image: img, sellerUser: s.user, createdAt: serverTimestamp()
                });
                location.reload();
            } catch (e) { alert("Error."); btn.disabled = false; }
        };

        function renderFeed() {
            const sellerLocal = JSON.parse(localStorage.getItem('adansiSeller'));
            if(sellerLocal) {
                document.getElementById('heroRegBtn').classList.add('hidden');
                document.getElementById('portalTabs').classList.remove('hidden');
            }

            onSnapshot(query(collection(db, "listings"), orderBy("createdAt", "desc")), (snaps) => {
                const feed = document.getElementById('app-feed');
                feed.innerHTML = "";
                snaps.forEach((d) => {
                    const itm = d.data();
                    const sData = allSellers[itm.sellerUser] || { name: "Seller", verified: false };
                    const isMine = sellerLocal && itm.sellerUser === sellerLocal.user;
                    if (!sData.verified && currentView === 'all') return;
                    if (currentView === 'mine' && !isMine) return;

                    feed.innerHTML += `
                        <div class="card">
                            <img src="${itm.image}" class="h-52 w-full object-cover">
                            <div class="p-5 flex flex-col flex-1">
                                <div class="flex items-center gap-2 mb-3">
                                    <img src="${sData.profilePic}" class="w-6 h-6 rounded-full border">
                                    <p class="text-[10px] font-black uppercase">${sData.name}</p>
                                </div>
                                <h3 class="font-bold text-lg mb-1">${itm.title}</h3>
                                <p class="text-green-600 font-black text-xl mb-4">₵${itm.price}</p>
                                <div class="mt-auto">
                                    <a href="https://wa.me/${sData.phone}?text=I want to buy ${itm.title}" target="_blank" class="block w-full bg-black text-white py-3 rounded-xl font-bold text-center text-xs">WhatsApp Seller</a>
                                </div>
                            </div>
                        </div>`;
                });
            });
        }

        async function loadAdminData() {
            const list = document.getElementById('admin-seller-list');
            list.innerHTML = "";
            Object.values(allSellers).forEach(s => {
                list.innerHTML += `
                <div class="p-6 border rounded-3xl flex justify-between bg-gray-50 items-center">
                    <div class="flex items-center gap-4">
                        <img src="${s.profilePic}" class="w-10 h-10 rounded-full object-cover">
                        <p class="font-bold text-sm">${s.name} (${s.cardNum})</p>
                    </div>
                    <img src="${s.cardPhoto}" class="h-12 w-20 object-cover rounded shadow" onclick="window.open('${s.cardPhoto}')">
                    <button onclick="approveSeller('${s.docId}')" class="bg-green-500 text-white px-4 py-2 rounded-full text-xs font-black">${s.verified ? 'VERIFIED' : 'APPROVE'}</button>
                </div>`;
            });
        }
        renderFeed();
    </script>
</body>
</html>
